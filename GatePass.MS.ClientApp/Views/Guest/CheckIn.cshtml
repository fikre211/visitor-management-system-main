@model GatePass.MS.Domain.ViewModels.RequestInformationViewModel
@using Microsoft.AspNetCore.Mvc.Localization

@inject IViewLocalizer Localizer

@{
    ViewBag.Title = "Request Search";
}

<style>
    /* --- Blue & Accent Blue Color Scheme --- */
    :root {
        --primary-blue: #1565c0; /* Deep Blue */
        --accent-blue: #1e88e5; /* Brighter Blue */
        --light-blue-bg: #f0f7ff; /* Very Light Blue Background */
        --border-blue: #bbdefb; /* Soft Blue Border */
        --text-dark: #333;
        --white: #ffffff;
    }

    /* --- Container & Card Styling --- */
    .card-custom {
        background-color: var(--white);
        border: 1px solid var(--border-blue);
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(21, 101, 192, 0.08);
        padding: 10px;
        margin-top: 10px;
    }

    /* --- Section Headers --- */
    .section-header {
        color: var(--primary-blue);
        border-bottom: 2px solid var(--light-blue-bg);
        padding-bottom: 10px;
        margin-bottom: 10px;
        margin-top: 10px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    /* --- Form Styling --- */
    .form-label-custom {
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .form-control-custom {
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 5px 55px;
        transition: all 0.3s ease;
        background-color: #fcfcfc;
    }

        .form-control-custom:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.2rem rgba(30, 136, 229, 0.25);
            background-color: var(--white);
        }

        .form-control-custom[readonly], .form-control-custom[disabled] {
            background-color: #e9ecef; /* Greyed out for readonly */
            color: #495057;
            border-color: #dee2e6;
        }

    /* --- Button Styling --- */
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--accent-blue) 0%, var(--primary-blue) 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        color: white;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
            color: white;
        }

    .btn-disabled-custom {
        background-color: #e0e0e0;
        color: #757575;
        border: 1px solid #bdbdbd;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        cursor: not-allowed;
    }

    /* --- Table Styling --- */
    .table-custom {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid var(--border-blue);
        border-radius: 8px;
        overflow: hidden;
    }

        .table-custom thead th {
            background-color: var(--light-blue-bg);
            color: var(--primary-blue);
            border-bottom: 1px solid var(--border-blue);
            padding: 12px;
            font-weight: 600;
        }

        .table-custom td {
            padding: 12px;
            border-bottom: 1px solid #f1f1f1;
            vertical-align: middle;
        }

    /* --- Search Bar Container --- */
    .search-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin: 40px auto;
        padding: 25px;
        background: var(--white);
        border: 1px solid var(--border-blue);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        max-width: 600px;
    }

    .search-input {
        padding: 12px 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s ease;
        flex-grow: 1;
    }

        .search-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }
</style>

<div class="container py-4">

    <form asp-action="CheckIn" method="post" class="search-container">
        <input type="number" id="requestId" name="requestId" required autofocus
               placeholder="Enter Request ID"
               class="search-input" />

        <button class="btn btn-primary-custom" type="submit">
            <i class="fas fa-search mr-2"></i> Search
        </button>
    </form>

    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger text-center shadow-sm" style="border-radius: 8px; max-width: 600px; margin: 0 auto;">
            <i class="fas fa-exclamation-triangle mr-2"></i> @ViewBag.ErrorMessage
        </div>
    }


    @if (ViewBag.FirstName != null)
    {
        <div class="card-custom">
            <div class="card-body">
                <form asp-action="Check" class="form-horizontal" enctype="multipart/form-data">
                    <input type="number" id="checkId" name="checkId" value="@ViewBag.requestId" hidden />

                    <h5 class="section-header">
                        <i class="fas fa-user-circle mr-2"></i> @Localizer["Guest Information"]
                    </h5>

                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label asp-for="GuestFirstName" class="form-label-custom">@Localizer["Given Name"]</label>
                            <input asp-for="GuestFirstName" class="form-control form-control-custom" value="@ViewBag.FirstName" readonly>
                            <span asp-validation-for="GuestFirstName" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 form-group">
                            <label asp-for="GuestLastName" class="form-label-custom">@Localizer["Last Name"]</label>
                            <input asp-for="GuestLastName" class="form-control form-control-custom" value="@ViewBag.LastName" readonly>
                            <span asp-validation-for="GuestLastName" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label asp-for="GuestEmail" class="form-label-custom">@Localizer["Email"]</label>
                            <input asp-for="GuestEmail" class="form-control form-control-custom" value="@ViewBag.Email" readonly>
                            <span asp-validation-for="GuestEmail" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 form-group">
                            <label asp-for="GuestPhoneNumber" class="form-label-custom">@Localizer["Phone Number"]</label>
                            <input asp-for="GuestPhoneNumber" class="form-control form-control-custom" type="tel" value="@ViewBag.Phone" readonly>
                            <span asp-validation-for="GuestPhoneNumber" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="Department" class="form-label-custom">@Localizer["Department"]</label>
                        <input asp-for="Department" class="form-control form-control-custom" value="@ViewBag.Department" readonly>
                        <span asp-validation-for="Department" class="text-danger small"></span>
                    </div>

                    <h5 class="section-header">
                        <i class="fas fa-info-circle mr-2"></i> @Localizer["Visit Details"]
                    </h5>

                    <div class="form-group">
                        <label asp-for="PurposeOfVisit" class="form-label-custom">@Localizer["Purpose Of Visit"]</label>
                        <textarea class="form-control form-control-custom" rows="2" disabled>@ViewBag.PurposeOfVisit</textarea>
                        <span asp-validation-for="PurposeOfVisit" class="text-danger small"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">@Localizer["Feedback"]</label>
                        <textarea class="form-control form-control-custom" rows="2" disabled>@ViewBag.Feedback</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label-custom">@Localizer["Approved Time Window"]</label>
                        <div class="d-flex flex-wrap p-3 rounded" style="background-color: var(--light-blue-bg); border: 1px solid var(--border-blue);">
                            <div class="mr-5 mb-2 mb-md-0">
                                <span class="text-muted small text-uppercase font-weight-bold">@Localizer["From"]</span><br>
                                <strong style="color: #2e7d32;">@ViewBag.ApprovedTimeStart</strong>
                            </div>
                            <div>
                                <span class="text-muted small text-uppercase font-weight-bold">@Localizer["To"]</span><br>
                                <strong style="color: #c62828;">@ViewBag.ApprovedTimeEnd</strong>
                            </div>
                        </div>
                    </div>

                    <h5 class="section-header">
                        <i class="fas fa-laptop mr-2"></i> @Localizer["Devices"]
                    </h5>
                    <div class="row mb-3">
                        <div class="col-12">
                            @if (ViewBag.Devices != null && ((ICollection<GatePass.MS.Domain.Device>)ViewBag.Devices).Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var device in (ICollection<GatePass.MS.Domain.Device>)ViewBag.Devices)
                                    {
                                        <div class="list-group-item border-0 mb-2 d-flex justify-content-between align-items-center shadow-sm"
                                             style="border-radius: 10px; background-color: #f8f9fa; padding: 15px;">

                                            <div class="d-flex align-items-start">
                                                <div class="d-flex align-items-center justify-content-center mr-3 mt-1"
                                                     style="width: 40px; height: 40px; min-width: 40px; background-color: #e7f1ff; border-radius: 50%; color: #0d6efd;">
                                                    <i class="fas fa-laptop"></i>
                                                </div>

                                                <div style="font-size: 14px;">

                                                    <div class="mb-1">
                                                        <span class="text-muted small font-weight-bold text-uppercase mr-1" style="font-size: 11px; letter-spacing: 0.5px;">
                                                            @Localizer["Item Name"]:
                                                        </span>
                                                        <span style="font-weight: 600; color: #004085; font-size: 15px;">
                                                            @device.DeviceName
                                                        </span>
                                                    </div>

                                                    <div class="mb-1">
                                                        <span class="text-muted small font-weight-bold text-uppercase mr-1" style="font-size: 11px; letter-spacing: 0.5px;">
                                                            @Localizer["Identifier"]:
                                                        </span>
                                                        <span class="text-dark font-weight-medium">
                                                            @device.Identifier
                                                        </span>
                                                    </div>

                                                    @if (!string.IsNullOrEmpty(device.Description))
                                                    {
                                                        <div>
                                                            <span class="text-muted small font-weight-bold text-uppercase mr-1" style="font-size: 11px; letter-spacing: 0.5px;">
                                                                @Localizer["Description"]:
                                                            </span>
                                                            <span class="text-secondary">
                                                                @device.Description
                                                            </span>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            <div class="pl-2">
                                                @if (device.IsGranted == true)
                                                {
                                                    <span class="badge badge-pill badge-light text-success border border-success px-3 py-2">
                                                        <i class="fas fa-check-circle mr-1"></i> @Localizer["Granted"]
                                                    </span>
                                                }
                                                else if (device.IsDenied == true)
                                                {
                                                    <span class="badge badge-pill badge-light text-danger border border-danger px-3 py-2">
                                                        <i class="fas fa-times-circle mr-1"></i> @Localizer["Denied"]
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-pill badge-light text-warning border border-warning px-3 py-2">
                                                        <i class="fas fa-clock mr-1"></i> @Localizer["Pending"]
                                                    </span>
                                                }
                                            </div>

                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center p-4" style="background-color: #f8f9fa; border-radius: 10px; border: 1px dashed #dee2e6;">
                                    <div class="mb-2" style="color: #adb5bd;">
                                        <i class="fas fa-laptop-medical fa-2x"></i>
                                    </div>
                                    <h6 class="text-muted mb-0">@Localizer["No devices declared."]</h6>
                                </div>
                            }
                        </div>
                    </div>

                    <h5 class="section-header">
                        <i class="fas fa-users mr-2"></i> @Localizer["Additional Guests"]
                    </h5>

                    <div class="row mb-3">
                        <div class="col-12 mb-3">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white border-right-0" style="border-radius: 8px 0 0 8px;"><i class="fas fa-search text-muted"></i></span>
                                </div>
                                <input type="text" id="guestSearch" class="form-control form-control-custom border-left-0" style="border-radius: 0 8px 8px 0;" placeholder="Search by First Name..." />
                            </div>
                        </div>

                        <div class="col-12">
                            @if (ViewBag.AdditionalGuests != null)
                            {
                                <div class="table-responsive">
                                    <table class="table table-custom table-hover" id="guestsTable">
                                        <thead>
                                            <tr>
                                                <th>@Localizer["First Name"]</th>
                                                <th>@Localizer["Last Name"]</th>
                                                <th>@Localizer["Email"]</th>
                                                <th>@Localizer["Phone"]</th>
                                                @* <th>@Localizer["Company"]</th> *@
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var guest in ((IEnumerable<dynamic>)ViewBag.AdditionalGuests).OrderBy(g => g.FirstName))
                                            {
                                                <tr>
                                                    <td class="font-weight-bold">@guest.FirstName</td>
                                                    <td>@guest.LastName</td>
                                                    <td>@guest.Email</td>
                                                    <td>@guest.Phone</td>
                                                    @* <td><span class="badge badge-light border">@guest.CompanyName.ToUpper()</span></td> *@
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light text-center border text-muted">@Localizer["No Additional Guests."]</div>
                            }
                        </div>
                    </div>

                    <script>
                        document.getElementById("guestSearch").addEventListener("keyup", function () {
                            let input = this.value.toLowerCase();
                            let rows = document.querySelectorAll("#guestsTable tbody tr");

                            rows.forEach(row => {
                                let firstName = row.cells[0].textContent.toLowerCase();
                                // Reset previous highlight
                                row.style.backgroundColor = "";
                                if (input && firstName.includes(input)) {
                                    row.style.backgroundColor = "#fff9c4"; // Soft Yellow Highlight
                                }
                            });
                        });
                    </script>

                    <div class="row mt-5 pt-3 border-top">
                        <div class="col-12 text-center">
                            @if (ViewBag.IsCheckedIn)
                            {
                                <button type="submit" class="btn btn-disabled-custom" disabled>
                                    <i class="fas fa-check-circle mr-2"></i> @Localizer["Checked In Already"]
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-primary-custom px-5">
                                    <i class="fas fa-sign-in-alt mr-2"></i> <strong>@Localizer["Check In"]</strong>
                                </button>
                            }
                        </div>
                    </div>

                </form>
            </div>
        </div>
    }
</div>