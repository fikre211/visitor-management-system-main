@model GatePass.MS.Domain.ViewModels.RequestInformationViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@using GatePass.MS.Domain
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Invite";
    var companyName = ViewContext.RouteData.Values["companyName"]?.ToString();
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    :root {
        font-family: 'Segoe UI', Arial, sans-serif;
        --primary-blue: #0d6efd; /* Bootstrap Primary */
        --dark-blue: #0a58ca;
        --accent-blue: #e7f1ff;
        --icon-color: #495057;
    }

    /* Card Styling */
    .custom-card {
        border: none;
        border-top: 4px solid var(--primary-blue);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 8px;
    }

    .card-body-padded {
        padding: 30px !important; /* Requested Padding */
    }

    /* Labels */
    .label-style {
        font-weight: 600;
        color: #343a40;
    }

    /* Input Groups & Icons */
    .input-group-text {
        background-color: var(--accent-blue);
        border-color: #ced4da;
        color: var(--primary-blue);
        min-width: 45px;
        justify-content: center;
    }

    .form-control:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Buttons */
    .btn-primary {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
    }

        .btn-primary:hover {
            background-color: var(--dark-blue);
        }

    .section-title {
        color: var(--primary-blue);
        border-bottom: 2px solid var(--accent-blue);
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .guest-block, .device-item {
        background-color: #f8f9fa;
        border-left: 4px solid var(--primary-blue) !important;
    }
</style>

<div class="col-md-12" style="padding: 50px">
    <div class="card custom-card">
        <div class="card-header p-2 bg-white">
        </div><div class="card-body card-body-padded">
            <div class="tab-content">
                <div class="active tab-pane" id="individual">
                    <form asp-action="Invite" id="inviteForm" class="form-horizontal" enctype="multipart/form-data">

                        <h5 class="section-title"><i class="fas fa-info-circle me-2"></i> @Localizer["Visitor Information"]</h5>

                        <div id="requests-container">
                            <div class="request-block">
                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["Title"]<span style="color: red;">*</span></label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                            </div>
                                            <select name="Title" asp-for="Title" class="form-control">
                                                <option value="Mr.">@Localizer["Mr."]</option>
                                                <option value="Ms.">@Localizer["Ms."]</option>
                                                <option value="Mrs.">@Localizer["Mrs."]</option>
                                                <option value="Hon.">@Localizer["Hon."]</option>
                                                <option value="HE.">@Localizer["HE."]</option>
                                                <option value="Sir.">@Localizer["Sir."]</option>
                                                <option value="Madam.">@Localizer["Madam."]</option>
                                                <option value="Dr.">@Localizer["Dr."]</option>
                                                <option value="Prof.">@Localizer["Prof."]</option>
                                                <option value="Eng.">@Localizer["Eng."]</option>
                                            </select>
                                        </div>
                                    </div>
                                    <span asp-validation-for="Title" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["GivenName"]<span style="color: red;">*</span></label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                            </div>
                                            <input name="GuestFirstName" asp-for="GuestFirstName" class="form-control" placeholder="@Localizer["GivenName"]">
                                        </div>
                                    </div>
                                    <span asp-validation-for="GuestFirstName" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["LastName"]</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="far fa-user"></i></span>
                                            </div>
                                            <input name="GuestLastName" asp-for="GuestLastName" class="form-control" placeholder="@Localizer["LastName"]">
                                        </div>
                                    </div>
                                    <span asp-validation-for="GuestLastName" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["Email"]</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                            </div>
                                            <input name="GuestEmail" asp-for="GuestEmail" class="form-control" type="email" placeholder="example@domain.com">
                                        </div>
                                    </div>
                                    <span asp-validation-for="GuestEmail" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["PhoneNumber"]<span style="color: red;">*</span></label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                            </div>
                                            <input name="GuestPhoneNumber"
                                                   asp-for="GuestPhoneNumber"
                                                   class="form-control"
                                                   type="text"
                                                   maxlength="15"
                                                   inputmode="numeric"
                                                   oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 15);"
                                                   placeholder="+1234567890"
                                                   required />
                                        </div>
                                    </div>
                                    <span asp-validation-for="GuestPhoneNumber" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["CompanyName"]</label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                                            </div>
                                            <input name="CompanyName" asp-for="CompanyName" class="form-control" placeholder="@Localizer["CompanyName"]">
                                        </div>
                                    </div>
                                    <span asp-validation-for="CompanyName" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["PurposeOfVisit"]<span style="color: red;">*</span></label>
                                    <div class="col-sm-10">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                                            </div>
                                            <input name="PurposeOfVisit" asp-for="PurposeOfVisit" class="form-control" placeholder="@Localizer["PurposeOfVisit"]" />
                                        </div>
                                    </div>
                                    <span asp-validation-for="PurposeOfVisit" class="text-danger offset-sm-2 col-sm-10"></span>
                                </div>

                                <h5 class="section-title mt-4"><i class="fas fa-clock me-2"></i> @Localizer["Visit Schedule"]</h5>

                                @if (companyName.ToLower() == "hopr")
                                {
                                    <div class="form-group row mb-3">
                                        <label class="col-sm-2 col-form-label label-style">@Localizer["visitDateRange"]<span style="color: red;">*</span></label>
                                        <div class="col-sm-10">
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label for="startDateIndividual" class="small text-muted"><i class="fas fa-calendar-check me-1" style="color: green"></i> @Localizer["from"]</label>
                                                    <div class="input-group">
                                                        <input class="form-control startDate" type="datetime-local"
                                                               data-val="true"
                                                               data-val-required="The VisitDateTimeStart field is required."
                                                               name="VisitDateTimeStart"
                                                               value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")"
                                                               min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")">
                                                    </div>
                                                    <input name="__Invariant" type="hidden" value="VisitDateTimeStart">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="endDateIndividual" class="small text-muted"><i class="fas fa-calendar-times me-1" style="color: #dc3545"></i> @Localizer["to"]</label>
                                                    <div class="input-group">
                                                        <input class="form-control endDate" type="datetime-local"
                                                               data-val="true"
                                                               data-val-required="The VisitDateTimeEnd field is required."
                                                               name="VisitDateTimeEnd"
                                                               value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")">
                                                    </div>
                                                    <input name="__Invariant" type="hidden" value="VisitDateTimeEnd">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="form-group row mb-3">
                                        <label class="col-sm-2 col-form-label label-style">@Localizer["visitDateRange"]<span style="color: red;">*</span></label>
                                        <div class="col-sm-10">
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label for="startDateIndividual" class="small text-muted"><i class="fas fa-calendar-check me-1" style="color: green"></i> @Localizer["from"]</label>
                                                    <div class="input-group">
                                                        <input class="form-control startDate" type="date" data-val="true" data-val-required="The VisitDateTimeStart field is required." name="VisitDateTimeStart"
                                                               min="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                                                    </div>
                                                    <input name="__Invariant" type="hidden" value="VisitDateTimeStart">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="endDateIndividual" class="small text-muted"><i class="fas fa-calendar-times me-1" style="color: #dc3545"></i> @Localizer["to"]</label>
                                                    <div class="input-group">
                                                        <input class="form-control endDate" type="date" data-val="true" data-val-required="The VisitDateTimeEnd field is required." name="VisitDateTimeEnd"
                                                               required>
                                                    </div>
                                                    <input name="__Invariant" type="hidden" value="VisitDateTimeEnd">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }

                                <h5 class="section-title mt-4"><i class="fas fa-laptop me-2"></i> @Localizer["Items / Devices"]</h5>

                                <div class="form-group row mb-3">
                                    <label class="col-sm-2 col-form-label label-style">@Localizer["items"]</label>
                                    <div class="col-sm-10">
                                        <div id="device-container"></div>
                                        <button type="button" class="btn btn-outline-primary" id="add-device">
                                            <i class="fas fa-plus-circle me-1"></i> @Localizer["addItem"]
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row mb-3" id="excel-upload-row" style="display:none;">
                            <label class="col-sm-2 col-form-label label-style">@Localizer["Upload from Excel"]</label>
                            <div class="col-sm-10 d-flex align-items-center">
                                <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display:none;" />
                                <button type="button" class="btn btn-success me-2" id="uploadExcelBtn">
                                    <i class="fas fa-file-excel me-1"></i> @Localizer["Upload Excel"]
                                </button>
                                <span id="excelFileName" class="text-muted ms-2"><i class="fas fa-file-alt me-1"></i> No file selected</span>
                            </div>
                        </div>

                        <h5 class="section-title mt-4"><i class="fas fa-users me-2"></i> @Localizer["Additional Guests"]</h5>

                        <div class="form-group row mb-3">
                            <label class="col-sm-2 col-form-label label-style">@Localizer["Additional Guests"]</label>
                            <div class="col-sm-10">
                                <div id="guests-container"></div>
                                <button type="button" class="btn btn-outline-primary" id="add-guest">
                                    <i class="fas fa-user-plus me-1"></i> @Localizer["add Visitor"]
                                </button>
                            </div>
                        </div>

                        <hr />

                        <div class="form-group row submit-button-group mt-4">
                            <div class="col-sm-12 d-flex justify-content-center">
                                <button type="submit" class="btn btn-primary request-visit-btn btn-lg shadow" style="min-width: 200px;">
                                    <i class="fas fa-paper-plane me-2"></i> <strong>@Localizer["Invite"]</strong>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {


    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
            integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjECaZnr46LuU/y92dBQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer">
    </script>
    <script>
        let guestIndex = 0;
        let hasUploadVisible = false;

        const addGuestBtn = document.getElementById('add-guest');
        const guestsContainer = document.getElementById('guests-container');

        const excelRow = document.getElementById('excel-upload-row');
        const uploadBtn = document.getElementById('uploadExcelBtn');
        const fileInput = document.getElementById('excelFileInput');
        const fileNameLabel = document.getElementById('excelFileName');

        // Show "Upload Excel" once when first visitor is added
        addGuestBtn.addEventListener('click', () => {
            if (!hasUploadVisible) {
                excelRow.style.display = 'flex';
                hasUploadVisible = true;
            }
            appendEmptyGuest();
        });

        // Clicking the upload button triggers the hidden file input
        uploadBtn.addEventListener('click', () => fileInput.click());

        // Handle file pick and parse
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fileNameLabel.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> ${file.name}`;

            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            // assume first sheet
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            // convert to JSON array of objects
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });

            // clear any existing guest blocks
            guestsContainer.innerHTML = '';
            guestIndex = 0;

            // for each row, append a guest block with values
            rows.forEach(row => {
                appendGuestFromRow(row);
            });
        });

        // helper to append an *empty* block (for manual add)
        function appendEmptyGuest() {
            const block = createGuestBlock();
            guestsContainer.appendChild(block);
            guestIndex++;
        }
        function getValue(row, key) {
            return row.hasOwnProperty(key) && row[key] !== undefined ? row[key] : '';
        }

        // helper to append a block filled from Excel row
        function appendGuestFromRow(row) {
            const block = createGuestBlock({
                FirstName: getValue(row, 'FirstName'),
                LastName: getValue(row, 'LastName'),
                Email: getValue(row, 'Email'),
                Phone: getValue(row, 'Phone')
            });

            guestsContainer.appendChild(block);
            guestIndex++;
        }


        // builds the DOM for one guest-block, optionally prefilled
        function createGuestBlock(prefill = {}) {
            const idx = guestIndex;
            const div = document.createElement('div');
            div.classList.add('guest-block', 'rounded', 'p-3', 'mb-3', 'shadow-sm');

            // Updated HTML structure with Professional Icons and Colors
            div.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 mb-2">
                             <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                </div>
                                <input name="AdditionalGuests[${idx}].FirstName"
                                       class="form-control"
                                       placeholder="First Name"
                                       required
                                       value="${prefill.FirstName || ''}" />
                            </div>
                        </div>

                        <div class="col-md-6 mb-2">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="far fa-user"></i></span>
                                </div>
                                <input name="AdditionalGuests[${idx}].LastName"
                                       class="form-control"
                                       placeholder="Last Name"
                                       required
                                       value="${prefill.LastName || ''}" />
                            </div>
                        </div>

                        <div class="col-md-6 mb-2">
                             <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                </div>
                                <input name="AdditionalGuests[${idx}].Email"
                                       class="form-control"
                                       placeholder="Email"
                                       type="email"
                                       value="${prefill.Email || ''}" />
                            </div>
                        </div>

                        <div class="col-md-6 mb-2">
                             <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                </div>
                                <input name="AdditionalGuests[${idx}].Phone"
                                       class="form-control"
                                       placeholder="Phone Number"
                                       type="text"
                                       maxlength="15"
                                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 15);"
                                       value="${prefill.Phone || ''}" />
                            </div>
                        </div>

                        <div class="col-12 text-right mt-2">
                            <button type="button" class="btn btn-danger btn-sm remove-guest float-right">
                                <i class="fas fa-trash-alt me-1"></i> @Localizer["Remove Visitor"]
                            </button>
                        </div>
                    </div>
                `;
            return div;
        }

        // remove-guest handler
        document.addEventListener('click', function (e) {
            if (e.target && e.target.closest('.remove-guest')) {
                e.target.closest('.guest-block').remove();
            }
        });
    </script>

    <script>
        let deviceIndex = 0; // Start index from 0

        // Function to update the name attributes of device input fields
        function updateDeviceIndexes() {
            const deviceItems = document.querySelectorAll('.device-item');
            deviceItems.forEach((deviceItem, index) => {
                // Update each input field's name attribute based on its new index
                const deviceNameInput = deviceItem.querySelector('input[name$=".DeviceName"]');
                const identifierInput = deviceItem.querySelector('input[name$=".Identifier"]');
                const descriptionTextarea = deviceItem.querySelector('textarea[name$=".Description"]');

                if (deviceNameInput) {
                    deviceNameInput.setAttribute('name', `Devices[${index}].DeviceName`);
                }
                if (identifierInput) {
                    identifierInput.setAttribute('name', `Devices[${index}].Identifier`);
                }
                if (descriptionTextarea) {
                    descriptionTextarea.setAttribute('name', `Devices[${index}].Description`);
                }
            });

            // Update deviceIndex for the next addition
            deviceIndex = deviceItems.length;
        }

        // Add new device input fields
        document.getElementById('add-device').addEventListener('click', function () {
            const container = document.getElementById('device-container');
            const newDevice = document.createElement('div');
            newDevice.classList.add('device-item', 'mb-3', 'p-3', 'rounded', 'shadow-sm', 'd-flex', 'align-items-start');

            // Updated HTML structure for Devices with Icons
            newDevice.innerHTML = `
                        <div class="form-row flex-grow-1 row">
                            <div class="form-group col-md-3 mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    </div>
                                    <input type="text" name="Devices[${deviceIndex}].DeviceName" class="form-control" placeholder="Item Name" required />
                                </div>
                            </div>
                            <div class="form-group col-md-3 mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                    </div>
                                    <input type="text" name="Devices[${deviceIndex}].Identifier" class="form-control" placeholder="Identifier/SN" required />
                                </div>
                            </div>
                            <div class="form-group col-md-6 mb-2">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-align-left"></i></span>
                                    </div>
                                    <textarea name="Devices[${deviceIndex}].Description" class="form-control" placeholder="Description" rows="1" required ></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-device ms-2 mt-1">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;

            container.appendChild(newDevice);
            deviceIndex++; // Increment index for the next added device
        });

        // Remove device input fields and update indexes
        document.addEventListener('click', function (e) {
            if (e.target && e.target.closest('.remove-device')) {
                e.target.closest('.device-item').remove(); // Remove the device item
                updateDeviceIndexes(); // Re-index the remaining devices
            }
        });

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const startDates = document.querySelectorAll('.startDate');
            const endDates = document.querySelectorAll('.endDate');

            startDates.forEach(startDate => {
                startDate.addEventListener('change', function () {
                    const startDateValue = new Date(this.value);
                    endDates.forEach(endDate => {
                        const endDateValue = new Date(endDate.value);
                        if (endDateValue < startDateValue) {
                            endDate.value = this.value;
                        }
                        endDate.min = this.value;
                        endDate.removeAttribute('readonly');
                    });
                });
            });

            endDates.forEach(endDate => {
                endDate.addEventListener('change', function () {
                    const endDateValue = new Date(this.value);
                    startDates.forEach(startDate => {
                        const startDateValue = new Date(startDate.value);
                        if (endDateValue < startDateValue) {
                            startDate.value = this.value;
                        }
                    });
                });
            });
        });
    </script>


    <script>

        let requestIndex = 1;

        // Note: The element ID 'add-request' was not in the HTML, but preserving script logic in case it's used elsewhere or hidden
        const addReqBtn = document.getElementById('add-request');
        if(addReqBtn){
            addReqBtn.addEventListener('click', function () {
                const container = document.getElementById('requests-container');
                const firstRequest = container.querySelector('.request-block').cloneNode(true);

                // Clean up cloned request block
                firstRequest.querySelectorAll('[name]').forEach(el => {
                    let oldName = el.name;
                    if (!oldName) return;

                    // Update index in name
                    el.name = oldName.replace(/\[\d+\]/, `[${requestIndex}]`);

                    // Reset values only for input/textarea (except file/image)
                    if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
                        if (el.type !== "file" && el.type !== "hidden") {
                            el.value = '';
                        }
                    }
                });
            });
        }

    </script>
}