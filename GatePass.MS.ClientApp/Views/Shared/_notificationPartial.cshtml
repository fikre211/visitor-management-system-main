@using GatePass.MS.ClientApp.Data
@using GatePass.MS.Domain
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> _userManager
@inject ApplicationDbContext _context
@inject GatePass.MS.ClientApp.Service.ICurrentCompany _current


@if (SignInManager.IsSignedIn(User))
{
    var currentUser = await _userManager.GetUserAsync(User);
    int? CurrentUserDepartmentId = currentUser?.Employee?.DepartmentId;
    // Use current request company from ICurrentCompany (ensures admin notifications are scoped to the company in the URL)
    int? CurrentCompanyId = _current?.Value?.Id;
    var isInSupervisorRole = await _userManager.IsInRoleAsync(currentUser, "Superviser");
    var isInAdminRole = await _userManager.IsInRoleAsync(currentUser, "Admin");
    @if (currentUser != null)
    {

        var today = DateTime.Today;

        // Start with a base query for requests and optionally filter by company
        var requestQuery = _context.RequestInformation.AsQueryable();
        if (CurrentCompanyId != null)
        {
            requestQuery = requestQuery.Where(r => r.CompanyId == CurrentCompanyId);
        }

        // Pending requests are meaningful only for supervisors
        int pendingRequestsCount = 0;
        if (isInSupervisorRole && CurrentUserDepartmentId != null)
        {
            pendingRequestsCount = requestQuery.Count(r =>
                r.Employee.DepartmentId == CurrentUserDepartmentId &&
                r.Status == "Pending" &&
                r.VisitDateTimeEnd >= today &&
                !r.Deleted
            );
        }

        // Outdated requests (optionally filtered by company when company is set)
        int OutDatedRequestsCount = requestQuery.Count(r =>
            r.VisitDateTimeStart < today &&
            r.Status == "Pending" &&
            !r.Deleted
        );

        // Locked accounts: show only for the current company (do NOT fall back to global)
        int lockedAccountCount = 0;
        if (CurrentCompanyId != null)
        {
            lockedAccountCount = _userManager.Users
                .Where(u => u.CompanyId == CurrentCompanyId && u.IsLocked)
                .Count();
        }


        @if (isInAdminRole)
        {
            int allNotification = OutDatedRequestsCount + lockedAccountCount;
            <li class="nav-item dropdown">

                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell"></i>
                    <span class="badge badge-warning navbar-badge">@allNotification</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">@allNotification Notifications</span>
                    <div class="dropdown-divider"></div>
                    <a asp-controller="Admin" asp-action="RequestTobeDeleted" class="dropdown-item">
                        <i class="fas fa-users mr-2"></i> @OutDatedRequestsCount  Out dated requests
                        <span class="float-right text-muted text-sm"></span>
                    </a>
                    <a asp-controller="Admin" asp-action="ViewLockedAccount" class="dropdown-item">
                        <i class="fas fa-users mr-2"></i> @lockedAccountCount  Locked Accounts
                        <span class="float-right text-muted text-sm"></span>
                    </a>

                </div>
            </li>

        }
        else

        @if (isInSupervisorRole)
        {
            int allNotification = pendingRequestsCount;
            <li class="nav-item dropdown">

                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell"></i>
                    <span class="badge badge-warning navbar-badge">@allNotification</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">@allNotification Notifications</span>
                    <div class="dropdown-divider"></div>
                    <a href="@Url.Action("Index", "RequestInformations", new { status = "pending" })" class="dropdown-item">
                        <i class="fas fa-users mr-2"></i> @pendingRequestsCount pending requests
                        <span class="float-right text-muted text-sm"></span>
                    </a>

                </div>
            </li>
        }
        else
        {
            int allNotification = 0;
            <li class="nav-item dropdown">

                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell"></i>
                    <span class="badge badge-warning navbar-badge">@allNotification</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">@allNotification Notifications</span>
                    <div class="dropdown-divider"></div>


                </div>
            </li>
        }
    }
}